<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Pengguna & API Key</title>
    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap)" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container-card {
            max-width: 900px;
        }
        .status-active {
            @apply bg-green-100 text-green-700 font-semibold px-2 py-1 rounded-full text-xs;
        }
        .status-inactive {
            @apply bg-red-100 text-red-700 font-semibold px-2 py-1 rounded-full text-xs;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 shadow-md;
        }
        .btn-secondary {
            @apply bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="flex justify-center items-start min-h-screen">
        <div class="container-card w-full bg-white p-6 md:p-10 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold mb-6 text-gray-800 text-center">MySQL API Key Manager</h1>

            <!-- AREA PESAN -->
            <div id="message-area" class="mb-4 hidden p-3 rounded-lg border border-transparent" role="alert">
                <p id="message-text" class="text-sm"></p>
            </div>

            <!-- 1. TAMPILAN REGISTRASI PENGGUNA -->
            <div id="user-registration-view">
                <h2 class="text-xl font-semibold mb-4 text-center">Registrasi Pengguna Baru & API Key</h2>
                <form id="user-registration-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="first_name" class="block text-sm font-medium text-gray-700">Nama Depan</label>
                            <input type="text" id="first_name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="last_name" class="block text-sm font-medium text-gray-700">Nama Belakang</label>
                            <input type="text" id="last_name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label for="user_email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="user_email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between pt-4 space-y-3 sm:space-y-0 sm:space-x-4">
                        <button type="submit" id="save-user-btn" class="btn-primary flex-1">
                            <span id="loader-reg" class="hidden animate-spin h-5 w-5 mr-3 border-t-2 border-r-2 border-white rounded-full"></span>
                            Simpan Pengguna & Buat API Key
                        </button>
                        <button type="button" onclick="showView('admin-login-view')" class="btn-secondary flex-1">Login Admin</button>
                    </div>
                </form>
            </div>

            <!-- 2. TAMPILAN LOGIN/REGISTRASI ADMIN -->
            <div id="admin-login-view" class="hidden">
                <h2 class="text-xl font-semibold mb-4 text-center">Akses Admin</h2>
                <form id="admin-auth-form" class="space-y-4">
                    <div>
                        <label for="admin_email" class="block text-sm font-medium text-gray-700">Email Admin</label>
                        <input type="email" id="admin_email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="admin_password" class="block text-sm font-medium text-gray-700">Password Admin</label>
                        <input type="password" id="admin_password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between pt-4 space-y-3 sm:space-y-0 sm:space-x-4">
                        <button type="button" id="login-admin-btn" class="btn-primary flex-1">Login</button>
                        <button type="button" id="register-admin-btn" class="btn-secondary flex-1">Registrasi Admin</button>
                    </div>
                    <button type="button" onclick="showView('user-registration-view')" class="w-full text-center text-sm text-gray-500 hover:text-gray-700 mt-4">Kembali ke Registrasi Pengguna</button>
                </form>
            </div>

            <!-- 3. TAMPILAN DASBOR ADMIN -->
            <div id="admin-dashboard-view" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Dasbor Admin</h2>
                    <button id="admin-logout-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-md transition duration-150">Logout</button>
                </div>

                <!-- Bagian Daftar Pengguna -->
                <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Daftar Pengguna (<span id="user-count">0</span>)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">ID</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nama Lengkap</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Email</th>
                                </tr>
                            </thead>
                            <tbody id="users-list" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <div id="users-loading" class="text-center py-4 text-gray-500 hidden">Memuat Pengguna...</div>
                    <div id="users-empty" class="text-center py-4 text-gray-500 hidden">Tidak ada pengguna terdaftar.</div>
                </div>

                <!-- Bagian Daftar API Keys -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold mb-4 text-gray-700">Daftar API Keys (<span id="keys-count">0</span>)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Key</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">User ID</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Kedaluwarsa</th>
                                    <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="keys-list" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    <div id="keys-loading" class="text-center py-4 text-gray-500 hidden">Memuat API Keys...</div>
                    <div id="keys-empty" class="text-center py-4 text-gray-500 hidden">Tidak ada API Keys terdaftar.</div>
                </div>
            </div>

            <!-- Loader Global -->
            <div id="global-loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
                    <div class="animate-spin h-6 w-6 border-4 border-blue-500 border-t-transparent rounded-full mr-3"></div>
                    <span class="text-gray-700 font-semibold">Memproses...</span>
                </div>
            </div>

        </div>
    </div>

    <script>
        // URL API Backend (Pastikan ini sesuai dengan port server.js)
        const API_BASE_URL = 'http://localhost:3000/api';

        let adminToken = localStorage.getItem('adminToken') || null;

        // --- FUNGSI UTILITAS UI ---

        function showMessage(text, type = 'info') {
            const area = document.getElementById('message-area');
            const textEl = document.getElementById('message-text');
            area.classList.remove('hidden', 'bg-green-100', 'border-green-400', 'text-green-700', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
            
            let classes = '';
            if (type === 'success') {
                classes = 'bg-green-100 border-green-400 text-green-700';
            } else if (type === 'error') {
                classes = 'bg-red-100 border-red-400 text-red-700';
            } else { 
                classes = 'bg-yellow-100 border-yellow-400 text-yellow-700';
            }
            area.classList.add(classes);
            textEl.textContent = text;
            setTimeout(() => area.classList.add('hidden'), 5000);
        }

        window.showView = function(viewId) {
            document.getElementById('user-registration-view').classList.add('hidden');
            document.getElementById('admin-login-view').classList.add('hidden');
            document.getElementById('admin-dashboard-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            document.getElementById('message-area').classList.add('hidden');
            
            if (viewId === 'admin-dashboard-view') {
                fetchDashboardData();
            }
        }

        function toggleGlobalLoader(show) {
            document.getElementById('global-loader').classList.toggle('hidden', !show);
        }

        function getStatus(expiresAt) {
            const now = new Date().getTime();
            const expiry = new Date(expiresAt).getTime();
            return expiry > now;
        }

        // --- FUNGSI INTERAKSI API ---

        async function registerAdmin(email, password) {
            toggleGlobalLoader(true);
            try {
                const response = await fetch(`${API_BASE_URL}/admin/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.message || 'Gagal mendaftarkan admin.');
                showMessage("Registrasi Admin berhasil! Silakan Login.", "success");
                document.getElementById('admin-auth-form').reset();
            } catch (error) {
                console.error("Gagal registrasi admin:", error);
                showMessage(`Gagal Registrasi Admin: ${error.message}`, "error");
            } finally {
                toggleGlobalLoader(false);
            }
        }

        async function loginAdmin(email, password) {
            toggleGlobalLoader(true);
            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await response.json();
                if (!response.ok || !data.token) throw new Error(data.message || 'Email atau Password Admin salah.');
                adminToken = data.token;
                localStorage.setItem('adminToken', adminToken);
                showView('admin-dashboard-view');
                showMessage("Login Admin berhasil! Selamat datang.", "success");
            } catch (error) {
                console.error("Gagal login admin:", error);
                showMessage(`Gagal Login Admin: ${error.message}`, "error");
            } finally {
                toggleGlobalLoader(false);
            }
        }

        async function registerUser(firstName, lastName, email) {
            document.getElementById('loader-reg').classList.remove('hidden');
            document.getElementById('save-user-btn').disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/user/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        email: email
                    })
                });
                const data = await response.json();
                if (!response.ok || !data.apiKey) throw new Error(data.message || 'Gagal registrasi pengguna.');
                showMessage(`Registrasi berhasil! API Key Anda: ${data.apiKey}. Kedaluwarsa: ${new Date(data.expiresAt).toLocaleDateString('id-ID')}`, "success");
                document.getElementById('user-registration-form').reset();
            } catch (error) {
                console.error("Gagal registrasi pengguna:", error);
                showMessage(`Gagal Registrasi Pengguna: ${error.message}`, "error");
            } finally {
                document.getElementById('loader-reg').classList.add('hidden');
                document.getElementById('save-user-btn').disabled = false;
            }
        }
        
        async function fetchDashboardData() {
            if (!adminToken) {
                showMessage("Sesi admin berakhir. Silakan login kembali.", "error");
                showView('admin-login-view');
                return;
            }
            document.getElementById('users-loading').classList.remove('hidden');
            document.getElementById('keys-loading').classList.remove('hidden');
            document.getElementById('users-list').innerHTML = '';
            document.getElementById('keys-list').innerHTML = '';
            document.getElementById('user-count').textContent = '...';
            document.getElementById('keys-count').textContent = '...';
            try {
                const response = await fetch(`${API_BASE_URL}/admin/dashboard`, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}` 
                    }
                });
                const data = await response.json();
                if (!response.ok || !data.users || !data.keys) {
                    if (response.status === 401 || response.status === 403) {
                         throw new Error('Token admin tidak valid atau kedaluwarsa. Silakan login ulang.');
                    }
                    throw new Error(data.message || 'Gagal memuat data dasbor.');
                }
                renderUsers(data.users);
                renderApiKeys(data.keys);
            } catch (error) {
                console.error("Gagal memuat data dasbor:", error);
                showMessage(`Gagal memuat data: ${error.message}`, "error");
                if (error.message.includes('login ulang')) logoutAdmin();
            } finally {
                document.getElementById('users-loading').classList.add('hidden');
                document.getElementById('keys-loading').classList.add('hidden');
            }
        }
        
        // --- FUNGSI RENDERING UI ---

        function renderUsers(users) {
            const userListEl = document.getElementById('users-list');
            userListEl.innerHTML = '';
            document.getElementById('user-count').textContent = users.length;
            document.getElementById('users-empty').classList.toggle('hidden', users.length > 0);
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-100');
                tr.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">${user.first_name} ${user.last_name}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${user.email}</td>
                `;
                userListEl.appendChild(tr);
            });
        }

        function renderApiKeys(keys) {
            const keysListEl = document.getElementById('keys-list');
            keysListEl.innerHTML = '';
            document.getElementById('keys-count').textContent = keys.length;
            document.getElementById('keys-empty').classList.toggle('hidden', keys.length > 0);
            keys.forEach(key => {
                const isActive = getStatus(key.expires_at);
                const statusClass = isActive ? 'status-active' : 'status-inactive';
                const statusText = isActive ? 'Active' : 'Out of Date';
                const expiryDate = new Date(key.expires_at).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' });
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-100');
                tr.innerHTML = `
                    <td class="px-3 py-2 text-sm font-mono text-gray-800 break-all">${key.api_key}</td>
                    <td class="px-3 py-2 text-sm text-gray-500">${key.user_id}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${expiryDate}</td>
                    <td class="px-3 py-2 whitespace-nowrap">
                        <span class="${statusClass}">${statusText}</span>
                    </td>
                `;
                keysListEl.appendChild(tr);
            });
        }

        // --- LOGIKA UTAMA & HANDLER EVENT ---

        function logoutAdmin() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            showView('admin-login-view');
            showMessage("Anda telah Logout dari Dasbor Admin.", "info");
        }

        document.getElementById('user-registration-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const firstName = document.getElementById('first_name').value.trim();
            const lastName = document.getElementById('last_name').value.trim();
            const email = document.getElementById('user_email').value.trim();
            if (firstName && lastName && email) {
                registerUser(firstName, lastName, email);
            } else {
                showMessage("Semua field harus diisi.", "error");
            }
        });

        document.getElementById('login-admin-btn').addEventListener('click', function() {
            const email = document.getElementById('admin_email').value.trim();
            const password = document.getElementById('admin_password').value;
            if (email && password) {
                loginAdmin(email, password);
            } else {
                showMessage("Email dan Password Admin harus diisi.", "error");
            }
        });

        document.getElementById('register-admin-btn').addEventListener('click', function() {
            const email = document.getElementById('admin_email').value.trim();
            const password = document.getElementById('admin_password').value;
            if (email && password) {
                registerAdmin(email, password);
            } else {
                showMessage("Email dan Password Admin harus diisi.", "error");
            }
        });

        document.getElementById('admin-logout-btn').addEventListener('click', logoutAdmin);

        window.onload = function() {
            if (adminToken) {
                showView('admin-dashboard-view');
            } else {
                showView('user-registration-view');
            }
        }
    </script>
</body>
</html>
